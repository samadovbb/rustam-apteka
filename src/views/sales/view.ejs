<%- include('../partials/header') %>

<div class="main-wrapper">
    <%- include('../partials/sidebar') %>

    <main class="main-content">
        <div class="topbar">
            <h2><%= title %></h2>
            <div class="user-info">
                <span><%= lang.common.welcome %>, <strong><%= locals.user ? user.full_name || user.login : 'Admin' %></strong></span>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><%= lang.sales.saleDetails %></h3>
                    <div>
                        <% if (debt && debt.status === 'active') { %>
                            <button onclick="calculateMarkup(<%= sale.id %>, <%= debt.id %>)" class="btn" style="margin-right: 10px; background-color: #ff9800; color: white;">
                                üìà Ustamani hisoblash
                            </button>
                        <% } %>
                        <a href="/sales/<%= sale.id %>/export" class="btn btn-success" style="margin-right: 10px; background-color: #28a745;">
                            üìä Excel ga eksport qilish
                        </a>
                        <button onclick="deleteSale(<%= sale.id %>)" class="btn btn-danger" style="margin-right: 10px;">O'chirish</button>
                        <a href="/sales" class="btn btn-secondary"><%= lang.common.backToList %></a>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4><%= lang.sales.saleInfo %></h4>
                    <p><strong><%= lang.table.id %>:</strong> #<%= sale.id %></p>
                    <p>
                        <strong><%= lang.common.date %>:</strong>
                        <span id="sale-date-display"><%= new Date(sale.sale_date).toLocaleDateString('ru-RU') %></span>
                        <button onclick="editSaleDate(<%= sale.id %>, '<%= sale.sale_date %>')" class="btn btn-sm btn-link" title="Sanani tahrirlash" style="padding: 0 5px; font-size: 0.9em;">
                            ‚úèÔ∏è
                        </button>
                    </p>
                    <p><strong><%= lang.table.customer %>:</strong> <%= sale.customer_name %> (<%= sale.customer_phone %>)</p>
                    <p>
                        <strong><%= lang.table.seller %>:</strong>
                        <span id="seller-name-display"><%= sale.seller_name %></span>
                        <button onclick="changeSeller(<%= sale.id %>, <%= sale.seller_id %>)" class="btn btn-sm btn-link" title="Sotuvchini o'zgartirish" style="padding: 0 5px; font-size: 0.9em;">
                            ‚úèÔ∏è
                        </button>
                    </p>
                    <p><strong><%= lang.common.status %>:</strong>
                        <% if (sale.status === 'paid') { %>
                            <span class="badge badge-success"><%= lang.status.paid %></span>
                        <% } else if (sale.status === 'partial') { %>
                            <span class="badge badge-warning"><%= lang.status.partial %></span>
                        <% } else { %>
                            <span class="badge badge-danger"><%= lang.status.unpaid %></span>
                        <% } %>
                    </p>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"><%= lang.sales.products %></h4>
                    <button onclick="showReturnDialog(<%= sale.id %>)" class="btn btn-warning">Mahsulotlarni qaytarish</button>
                </div>
                <div class="table-responsive">
                    <table id="items-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="select-all-items" onchange="toggleAllItems(this)">
                                </th>
                                <th><%= lang.table.product %></th>
                                <th><%= lang.table.barcode %></th>
                                <th><%= lang.table.quantity %></th>
                                <th><%= lang.table.unitPrice %></th>
                                <th><%= lang.table.subtotal %></th>
                            </tr>
                        </thead>
                        <tbody>
                            <% items.forEach(item => { %>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="item-checkbox"
                                               data-item-id="<%= item.id %>"
                                               data-product-id="<%= item.product_id %>"
                                               data-quantity="<%= item.quantity %>"
                                               data-unit-price="<%= item.unit_price %>"
                                               data-product-name="<%= item.product_name %>">
                                    </td>
                                    <td><%= item.product_name %></td>
                                    <td><%= item.barcode %></td>
                                    <td><%= item.quantity %></td>
                                    <td>$<%= parseFloat(item.unit_price || 0).toFixed(2) %></td>
                                    <td>$<%= parseFloat(item.subtotal || 0).toFixed(2) %></td>
                                </tr>
                            <% }) %>
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: bold; background-color: #f8f9fa;">
                                <td></td>
                                <td colspan="2" style="text-align: right;">Jami:</td>
                                <td><%= items.reduce((sum, item) => sum + item.quantity, 0) %></td>
                                <td></td>
                                <td>$<%= parseFloat(sale.total_amount || 0).toFixed(2) %></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <%
                // Calculate actual remaining balance from payment history and markups
                let actualRemaining = parseFloat(sale.total_amount);

                // Combine payments and markups to calculate actual balance
                let allTransactions = [];

                payments.forEach(payment => {
                    allTransactions.push({
                        type: 'payment',
                        date: new Date(payment.payment_date),
                        amount: parseFloat(payment.amount)
                    });
                });

                if (markupLogs && markupLogs.length > 0) {
                    markupLogs.forEach(markup => {
                        allTransactions.push({
                            type: 'markup',
                            date: new Date(markup.calculation_date),
                            amount: parseFloat(markup.markup_value || 0)
                        });
                    });
                }

                // Sort by date and calculate balance
                allTransactions.sort((a, b) => a.date - b.date);
                allTransactions.forEach(transaction => {
                    if (transaction.type === 'payment') {
                        actualRemaining -= transaction.amount;
                    } else {
                        actualRemaining += transaction.amount;
                    }
                });
                %>

                <div style="text-align: right; margin: 20px 0;">
                    <h4>Umumiy summa: $<%= parseFloat(sale.total_amount || 0).toFixed(2) %></h4>
                    <p><strong>Boshlang'ich to'lov:</strong> $<%= initialPayment ? parseFloat(initialPayment.amount || 0).toFixed(2) : '0.00' %></p>
                    <p style="color: <%= actualRemaining > 0 ? 'red' : 'green' %>;">
                        <strong>Qoldiq qarz:</strong> $<%= actualRemaining.toFixed(2) %>
                    </p>
                </div>

                <% if (payments.length > 0 || (markupLogs && markupLogs.length > 0)) { %>
                    <h4>To'lov va Ustama tarixi</h4>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sana</th>
                                    <th>Summa</th>
                                    <th>Turi</th>
                                    <th>Qoldiq</th>
                                    <th>Harakat</th>
                                </tr>
                            </thead>
                            <tbody>
                                <%
                                let runningBalance = parseFloat(sale.total_amount);

                                // Combine payments and markup logs
                                let combinedHistory = [];

                                // Add payments
                                payments.forEach(payment => {
                                    combinedHistory.push({
                                        type: 'payment',
                                        date: new Date(payment.payment_date),
                                        payment: payment
                                    });
                                });

                                // Add markup logs if they exist
                                if (markupLogs && markupLogs.length > 0) {
                                    markupLogs.forEach(markup => {
                                        combinedHistory.push({
                                            type: 'markup',
                                            date: new Date(markup.calculation_date),
                                            markup: markup
                                        });
                                    });
                                }

                                // Sort by date
                                combinedHistory.sort((a, b) => a.date - b.date);
                                %>

                                <tr style="background: #f8f9fa;">
                                    <td><%= new Date(sale.sale_date).toLocaleDateString('ru-RU') %></td>
                                    <td><strong>Umumiy summa</strong></td>
                                    <td>-</td>
                                    <td style="font-weight: bold;">$<%= runningBalance.toFixed(2) %></td>
                                    <td>-</td>
                                </tr>

                                <% combinedHistory.forEach(item => {
                                    if (item.type === 'payment') {
                                        runningBalance -= parseFloat(item.payment.amount);
                                %>
                                    <tr>
                                        <td id="payment-date-<%= item.payment.id %>"><%= item.date.toLocaleDateString('ru-RU') %></td>
                                        <td style="color: green; font-weight: bold;">-$<%= parseFloat(item.payment.amount || 0).toFixed(2) %></td>
                                        <td><%= item.payment.payment_method %></td>
                                        <td style="font-weight: bold;">$<%= runningBalance.toFixed(2) %></td>
                                        <td>
                                            <button onclick="editPaymentDate(<%= sale.id %>, <%= item.payment.id %>, '<%= item.payment.payment_date %>')" class="btn btn-sm btn-link" title="Sanani tahrirlash" style="padding: 0; font-size: 0.9em;">
                                                ‚úèÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                <% } else if (item.type === 'markup') {
                                        const markupValue = parseFloat(item.markup.markup_value || 0);
                                        runningBalance += markupValue;
                                %>
                                    <tr style="background: #fff8e1;">
                                        <td><%= item.date.toLocaleDateString('ru-RU') %></td>
                                        <td style="color: orange; font-weight: bold;">
                                            <% if (debt && debt.markup_type === 'fixed') { %>
                                                +$<%= markupValue.toFixed(2) %>
                                            <% } else { %>
                                                <%= parseFloat(item.markup.markup_percent || 0).toFixed(2) %>% = +$<%= markupValue.toFixed(2) %>
                                            <% } %>
                                        </td>
                                        <td>Ustama</td>
                                        <td style="font-weight: bold;">$<%= runningBalance.toFixed(2) %></td>
                                        <td>-</td>
                                    </tr>
                                <% }
                                }) %>

                                <tr style="background: #fff3cd; font-size: 1.1em;">
                                    <td colspan="3"><strong>QOLDIQ:</strong></td>
                                    <td style="color: <%= runningBalance > 0 ? 'red' : 'green' %>; font-weight: bold; font-size: 1.2em;">$<%= runningBalance.toFixed(2) %></td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                <% } %>

                <!-- Payment form (always visible, allows overpayments) -->
                <div class="card" style="margin-top: 20px; background: #fff3cd;">
                    <h4><%= lang.sales.addPayment %></h4>
                    <form id="paymentForm" action="/sales/<%= sale.id %>/payment" method="POST" style="display: flex; gap: 10px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label for="amount" class="form-label"><%= lang.sales.amount %></label>
                            <input type="number" step="0.01" id="amount" name="amount" class="form-control" required>
                        </div>
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label for="payment_method" class="form-label"><%= lang.sales.method %></label>
                            <select id="payment_method" name="payment_method" class="form-control">
                                <option value="naqt"><%= lang.sales.cash %></option>
                                <option value="card"><%= lang.sales.card %></option>
                                <option value="transfer"><%= lang.sales.transfer %></option>
                                <option value="other"><%= lang.sales.other %></option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary"><%= lang.sales.addPayment %></button>
                    </form>
                </div>

                <!-- Debt Information Section -->
                <% if (debt) { %>
                    <hr style="margin: 30px 0;">
                    <h3>Qarz ma'lumotlari</h3>

                    <div style="margin-bottom: 20px;">
                        <p><strong>Asl qarz:</strong> $<%= parseFloat(debt.original_amount || 0).toFixed(2) %></p>
                        <p><strong>Joriy qarz (asosiy):</strong> $<%= parseFloat(debtCalculation.baseAmount || 0).toFixed(2) %></p>

                        <p><strong>Holat:</strong>
                            <% if (debt.status === 'active') { %>
                                <span class="badge badge-danger">Faol</span>
                            <% } else if (debt.status === 'paid') { %>
                                <span class="badge badge-success">To'landi</span>
                            <% } else { %>
                                <span class="badge badge-secondary">Bekor qilindi</span>
                            <% } %>
                        </p>
                    </div>

                    <!-- Debt Payment History -->
                    <% if (debtPaymentHistory.length > 0) { %>
                        <h4>Qarz bo'yicha to'lovlar tarixi</h4>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Sana</th>
                                        <th>Summa</th>
                                        <th>To'lov turi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% debtPaymentHistory.forEach(payment => { %>
                                        <tr>
                                            <td><%= new Date(payment.payment_date).toLocaleDateString('ru-RU') %></td>
                                            <td style="color: green; font-weight: bold;">-$<%= parseFloat(payment.amount || 0).toFixed(2) %></td>
                                            <td><%= payment.payment_method %></td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                <% } %>
            </div>
        </div>
    </main>
</div>

<%- include('../partials/footer') %>

<script>
// Helper function to convert any date to local YYYY-MM-DD format
function toLocalDateString(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Payment form handler (always active, allows overpayments)
document.getElementById('paymentForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    try {
        // Show date picker with session date (uses last input date)
        const selectedDate = await showDatePicker('To\'lov sanasini tanlang');

        if (selectedDate) {
            // Add the date to form
            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'payment_date';
            dateInput.value = selectedDate;
            this.appendChild(dateInput);

            // Submit the form
            this.submit();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Xatolik yuz berdi');
    }
});

async function calculateMarkup(saleId, debtId) {
    const result = await Swal.fire({
        title: 'Ustamani hisoblash',
        text: 'Bu savdo uchun ustama hisoblashni xohlaysizmi?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Ha, hisoblash',
        cancelButtonText: 'Bekor qilish',
        confirmButtonColor: '#ff9800',
        cancelButtonColor: '#6c757d'
    });

    if (result.isConfirmed) {
        try {
            const response = await fetch(`/sales/${saleId}/calculate-markup`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (data.success) {
                Swal.fire('Muvaffaqiyat!', data.message, 'success')
                    .then(() => window.location.reload());
            } else {
                Swal.fire('Xato!', data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire('Xato!', 'Ustamani hisoblashda xatolik yuz berdi', 'error');
        }
    }
}

async function deleteSale(id) {
    const result = await Swal.fire({
        title: 'Ishonchingiz komilmi?',
        text: 'Bu savdoni o\'chirishni xohlaysizmi? Bu harakat inventarizatsiyani tiklaydi va bekor qilib bo\'lmaydi!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ha, o\'chirish',
        cancelButtonText: 'Bekor qilish',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6'
    });

    if (result.isConfirmed) {
        try {
            const response = await fetch(`/sales/${id}`, { method: 'DELETE' });
            const data = await response.json();
            if (data.success) {
                Swal.fire('O\'chirildi!', data.message, 'success')
                    .then(() => window.location.href = '/sales');
            } else {
                Swal.fire('Xato!', data.error, 'error');
            }
        } catch (error) {
            Swal.fire('Xato!', 'O\'chirishda xatolik yuz berdi', 'error');
        }
    }
}

async function editSaleDate(saleId, currentDate) {
    try {
        // Show date picker with session date (uses last input date)
        const selectedDate = await showDatePicker('Savdo sanasini tahrirlang');

        if (selectedDate) {
            const response = await fetch(`/sales/${saleId}/date`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ sale_date: selectedDate })
            });

            const data = await response.json();

            if (data.success) {
                // Update display using local date parsing
                const [year, month, day] = selectedDate.split('-');
                const localDate = new Date(year, month - 1, day);
                const displayDate = localDate.toLocaleDateString('ru-RU');
                document.getElementById('sale-date-display').textContent = displayDate;

                Swal.fire('Yangilandi!', data.message, 'success');
            } else {
                Swal.fire('Xato!', data.error, 'error');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Xato!', 'Sanani yangilashda xatolik yuz berdi', 'error');
    }
}

async function editPaymentDate(saleId, paymentId, currentDate) {
    try {
        // Show date picker with session date (uses last input date)
        const selectedDate = await showDatePicker('To\'lov sanasini tahrirlang');

        if (selectedDate) {
            const response = await fetch(`/sales/${saleId}/payment/${paymentId}/date`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ payment_date: selectedDate })
            });

            const data = await response.json();

            if (data.success) {
                // Update display using local date parsing
                const [year, month, day] = selectedDate.split('-');
                const localDate = new Date(year, month - 1, day);
                const displayDate = localDate.toLocaleDateString('ru-RU');
                document.getElementById(`payment-date-${paymentId}`).textContent = displayDate;

                Swal.fire('Yangilandi!', data.message, 'success');
            } else {
                Swal.fire('Xato!', data.error, 'error');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Xato!', 'Sanani yangilashda xatolik yuz berdi', 'error');
    }
}

// Change seller function
async function changeSeller(saleId, currentSellerId) {
    try {
        // Fetch list of sellers
        const response = await fetch('/sellers/api/all');
        const sellers = await response.json();

        // Create options for the select
        const options = {};
        sellers.forEach(seller => {
            options[seller.id] = seller.full_name;
        });

        const { value: newSellerId } = await Swal.fire({
            title: 'Sotuvchini o\'zgartirish',
            input: 'select',
            inputOptions: options,
            inputValue: currentSellerId,
            showCancelButton: true,
            confirmButtonText: 'O\'zgartirish',
            cancelButtonText: 'Bekor qilish',
            inputValidator: (value) => {
                if (!value) {
                    return 'Sotuvchini tanlang!'
                }
            }
        });

        if (newSellerId && newSellerId !== String(currentSellerId)) {
            const updateResponse = await fetch(`/sales/${saleId}/seller`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ seller_id: newSellerId })
            });

            const data = await updateResponse.json();

            if (data.success) {
                Swal.fire('Yangilandi!', data.message, 'success')
                    .then(() => window.location.reload());
            } else {
                Swal.fire('Xato!', data.error, 'error');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Xato!', 'Sotuvchini o\'zgartirishda xatolik yuz berdi', 'error');
    }
}

// Toggle all items checkbox
function toggleAllItems(checkbox) {
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    itemCheckboxes.forEach(cb => cb.checked = checkbox.checked);
}

// Show return dialog
async function showReturnDialog(saleId) {
    const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');

    if (selectedCheckboxes.length === 0) {
        Swal.fire('Diqqat!', 'Qaytarish uchun kamida bitta mahsulot tanlang', 'warning');
        return;
    }

    // Build list of selected items with quantity inputs
    let htmlContent = '<div style="text-align: left;">';
    const itemsData = [];

    selectedCheckboxes.forEach(checkbox => {
        const itemId = checkbox.dataset.itemId;
        const productName = checkbox.dataset.productName;
        const maxQuantity = parseInt(checkbox.dataset.quantity);
        const unitPrice = parseFloat(checkbox.dataset.unitPrice);

        itemsData.push({
            sale_item_id: itemId,
            product_name: productName,
            max_quantity: maxQuantity,
            unit_price: unitPrice
        });

        htmlContent += `
            <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <strong>${productName}</strong><br>
                <label style="margin-top: 5px;">Qaytariladigan miqdor (Max: ${maxQuantity}):</label>
                <input type="number" id="qty-${itemId}" class="swal2-input" min="1" max="${maxQuantity}" value="${maxQuantity}" style="margin: 5px 0;">
            </div>
        `;
    });

    htmlContent += '<div style="margin-top: 15px;">';
    htmlContent += '<label>Qaytarish sababi (ixtiyoriy):</label>';
    htmlContent += '<textarea id="return-reason" class="swal2-textarea" placeholder="Sabab kiriting..."></textarea>';
    htmlContent += '</div></div>';

    const result = await Swal.fire({
        title: 'Mahsulotlarni qaytarish',
        html: htmlContent,
        width: '600px',
        showCancelButton: true,
        confirmButtonText: 'Qaytarish',
        cancelButtonText: 'Bekor qilish',
        confirmButtonColor: '#f39c12',
        preConfirm: () => {
            const items = [];
            let hasError = false;

            itemsData.forEach(item => {
                const qtyInput = document.getElementById(`qty-${item.sale_item_id}`);
                const quantity = parseInt(qtyInput.value);

                if (!quantity || quantity < 1) {
                    hasError = true;
                    Swal.showValidationMessage('Barcha mahsulotlar uchun miqdor kiriting');
                    return;
                }

                if (quantity > item.max_quantity) {
                    hasError = true;
                    Swal.showValidationMessage(`${item.product_name} uchun maksimal miqdor ${item.max_quantity}`);
                    return;
                }

                items.push({
                    sale_item_id: parseInt(item.sale_item_id),
                    quantity: quantity
                });
            });

            if (hasError) return false;

            return {
                items: items,
                reason: document.getElementById('return-reason').value
            };
        }
    });

    if (result.isConfirmed && result.value) {
        try {
            const response = await fetch(`/sales/${saleId}/return`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(result.value)
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire('Qaytarildi!', data.message, 'success')
                    .then(() => window.location.reload());
            } else {
                Swal.fire('Xato!', data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire('Xato!', 'Mahsulotlarni qaytarishda xatolik yuz berdi', 'error');
        }
    }
}
</script>
