<%- include('../partials/header') %>

<div class="main-wrapper">
    <%- include('../partials/sidebar') %>

    <main class="main-content">
        <div class="topbar">
            <h2><%= title %></h2>
            <div class="user-info">
                <span><%= lang.common.welcome %>, <strong><%= locals.user ? user.full_name || user.login : 'Admin' %></strong></span>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><%= lang.stockTransfer.transferToSeller %></h3>
                    <a href="/stock-transfer" class="btn btn-secondary"><%= lang.common.backToList %></a>
                </div>

                <% if (error) { %>
                    <div class="alert alert-danger"><%= error %></div>
                <% } %>

                <form action="/stock-transfer" method="POST" id="transferForm" data-validate-form>
                    <div class="form-group">
                        <label for="seller_id" class="form-label required"><%= lang.stockTransfer.seller %></label>
                        <select id="seller_id" name="seller_id" class="form-control" data-validate="required" required>
                            <option value=""><%= lang.stockTransfer.selectSeller %></option>
                            <% sellers.forEach(seller => { %>
                                <option value="<%= seller.id %>"><%= seller.full_name %></option>
                            <% }) %>
                        </select>
                        <span class="form-error"></span>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><%= lang.stockTransfer.productsFromWarehouse %></label>
                        <div id="productsList">
                            <div class="product-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start;">
                                <select class="form-control product-select" style="flex: 2;" required>
                                    <option value=""><%= lang.stockIntake.selectProduct %></option>
                                    <% warehouseStock.forEach(item => { %>
                                        <option value="<%= item.product_id %>" data-available="<%= item.quantity %>" data-sell="<%= item.sell_price %>">
                                            <%= item.product_name %> (<%= lang.stockIntake.available %>: <%= item.quantity %>)
                                        </option>
                                    <% }) %>
                                </select>
                                <input type="number" class="form-control quantity-input" placeholder="<%= lang.stockIntake.quantity %>" min="1" style="flex: 1;" required>
                                <input type="number" step="0.01" class="form-control price-input" placeholder="<%= lang.stockTransfer.sellerPrice %>" min="0" style="flex: 1;" required>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addProductRow()"><%= lang.stockIntake.addProduct %></button>
                    </div>

                    <div class="form-group">
                        <label for="notes" class="form-label"><%= lang.common.notes %></label>
                        <textarea id="notes" name="notes" class="form-control" rows="3"></textarea>
                    </div>

                    <input type="hidden" name="items" id="itemsData">

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary"><%= lang.stockTransfer.transferStock %></button>
                        <a href="/stock-transfer" class="btn btn-secondary"><%= lang.buttons.cancel %></a>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>

<%- include('../partials/footer') %>

<script>
function addProductRow() {
    const container = document.getElementById('productsList');
    const newRow = container.querySelector('.product-item').cloneNode(true);
    newRow.querySelectorAll('input, select').forEach(input => input.value = '');
    container.appendChild(newRow);
}

document.getElementById('transferForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const items = [];
    document.querySelectorAll('.product-item').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const productId = productSelect.value;
        const quantity = row.querySelector('.quantity-input').value;
        const price = row.querySelector('.price-input').value;

        if (productId && quantity && price) {
            const available = parseInt(productSelect.selectedOptions[0].dataset.available);
            if (parseInt(quantity) > available) {
                alert('<%= lang.stockTransfer.onlyAvailable %>'.replace('{qty}', available));
                throw new Error('Insufficient stock');
            }

            items.push({
                product_id: parseInt(productId),
                quantity: parseInt(quantity),
                seller_price: parseFloat(price)
            });
        }
    });

    if (items.length === 0) {
        alert('<%= lang.validation.atLeastOneProduct %>');
        return;
    }

    try {
        // Show date picker with session date (uses last input date)
        const selectedDate = await showDatePicker('O\'tkazma sanasini tanlang');

        if (selectedDate) {
            // Add the date to form
            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'transfer_date';
            dateInput.value = selectedDate;
            this.appendChild(dateInput);

            // Set items data
            document.getElementById('itemsData').value = JSON.stringify(items);

            // Submit the form
            this.submit();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Xatolik yuz berdi');
    }
});

// Auto-fill suggested sell price
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('product-select')) {
        const option = e.target.selectedOptions[0];
        const row = e.target.closest('.product-item');
        if (option.dataset.sell) {
            row.querySelector('.price-input').value = option.dataset.sell;
        }
    }
});

// Initialize Select2 for seller
$(document).ready(function() {
    $('#seller_id').select2({
        ajax: {
            url: '/sellers/api/search',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term || ''
                };
            },
            processResults: function (data) {
                return {
                    results: data.map(function(seller) {
                        return {
                            id: seller.id,
                            text: seller.full_name
                        };
                    })
                };
            },
            cache: true
        },
        placeholder: '<%= lang.stockTransfer.selectSeller %>',
        minimumInputLength: 0,
        allowClear: true
    });

    // Initialize Select2 for product selects (warehouse stock only)
    function initializeProductSelect(element) {
        $(element).select2({
            ajax: {
                url: '/products/api/search',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term || ''
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.map(function(product) {
                            return {
                                id: product.id,
                                text: product.name + ' (' + product.barcode + ')',
                                product: product
                            };
                        })
                    };
                },
                cache: true
            },
            placeholder: '<%= lang.stockIntake.selectProduct %>',
            minimumInputLength: 0,
            allowClear: true,
            dropdownParent: $(element).parent()
        });

        // Auto-fill prices when product is selected
        $(element).on('select2:select', function (e) {
            var product = e.params.data.product;
            var row = $(this).closest('.product-item');
            if (product.sell_price) {
                row.find('.price-input').val(product.sell_price);
            }
        });
    }

    // Initialize existing product select
    $('.product-select').each(function() {
        initializeProductSelect(this);
    });

    // Override addProductRow to initialize Select2 on new rows
    window.originalAddProductRow = window.addProductRow;
    window.addProductRow = function() {
        const container = document.getElementById('productsList');
        const newRow = container.querySelector('.product-item').cloneNode(true);
        newRow.querySelectorAll('input').forEach(input => input.value = '');

        // Remove Select2 from cloned select
        const select = newRow.querySelector('.product-select');
        $(select).removeClass('select2-hidden-accessible').removeAttr('data-select2-id').removeAttr('aria-hidden').removeAttr('tabindex');
        $(select).next('.select2-container').remove();
        select.value = '';

        container.appendChild(newRow);

        // Initialize Select2 on new row
        initializeProductSelect(select);
    };
});
</script>
