<%- include('../partials/header') %>

<div class="main-wrapper">
    <%- include('../partials/sidebar') %>

    <main class="main-content">
        <div class="topbar">
            <h2><%= title %></h2>
            <div class="user-info">
                <span>Welcome, <strong><%= locals.user ? user.full_name || user.login : 'Admin' %></strong></span>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Transfer Stock to Seller</h3>
                    <a href="/stock-transfer" class="btn btn-secondary">Back to List</a>
                </div>

                <% if (error) { %>
                    <div class="alert alert-danger"><%= error %></div>
                <% } %>

                <form action="/stock-transfer" method="POST" id="transferForm" data-validate-form>
                    <div class="form-group">
                        <label for="seller_id" class="form-label required">Seller</label>
                        <select id="seller_id" name="seller_id" class="form-control" data-validate="required" required>
                            <option value="">Select Seller</option>
                            <% sellers.forEach(seller => { %>
                                <option value="<%= seller.id %>"><%= seller.full_name %></option>
                            <% }) %>
                        </select>
                        <span class="form-error"></span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Products from Warehouse</label>
                        <div id="productsList">
                            <div class="product-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start;">
                                <select class="form-control product-select" style="flex: 2;" required>
                                    <option value="">Select Product</option>
                                    <% warehouseStock.forEach(item => { %>
                                        <option value="<%= item.product_id %>" data-available="<%= item.quantity %>" data-sell="<%= item.sell_price %>">
                                            <%= item.product_name %> (Available: <%= item.quantity %>)
                                        </option>
                                    <% }) %>
                                </select>
                                <input type="number" class="form-control quantity-input" placeholder="Quantity" min="1" style="flex: 1;" required>
                                <input type="number" step="0.01" class="form-control price-input" placeholder="Seller Price" min="0" style="flex: 1;" required>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addProductRow()">+ Add Product</button>
                    </div>

                    <div class="form-group">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea id="notes" name="notes" class="form-control" rows="3"></textarea>
                    </div>

                    <input type="hidden" name="items" id="itemsData">

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Transfer Stock</button>
                        <a href="/stock-transfer" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>

<script>
function addProductRow() {
    const container = document.getElementById('productsList');
    const newRow = container.querySelector('.product-item').cloneNode(true);
    newRow.querySelectorAll('input, select').forEach(input => input.value = '');
    container.appendChild(newRow);
}

document.getElementById('transferForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const items = [];
    document.querySelectorAll('.product-item').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const productId = productSelect.value;
        const quantity = row.querySelector('.quantity-input').value;
        const price = row.querySelector('.price-input').value;

        if (productId && quantity && price) {
            const available = parseInt(productSelect.selectedOptions[0].dataset.available);
            if (parseInt(quantity) > available) {
                alert(`Only ${available} units available for this product`);
                throw new Error('Insufficient stock');
            }

            items.push({
                product_id: parseInt(productId),
                quantity: parseInt(quantity),
                seller_price: parseFloat(price)
            });
        }
    });

    if (items.length === 0) {
        alert('Please add at least one product');
        return;
    }

    document.getElementById('itemsData').value = JSON.stringify(items);
    this.submit();
});

// Auto-fill suggested sell price
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('product-select')) {
        const option = e.target.selectedOptions[0];
        const row = e.target.closest('.product-item');
        if (option.dataset.sell) {
            row.querySelector('.price-input').value = option.dataset.sell;
        }
    }
});
</script>

<%- include('../partials/footer') %>
