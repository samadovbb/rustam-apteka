<%- include('../partials/header') %>

<div class="main-wrapper">
    <%- include('../partials/sidebar') %>

    <main class="main-content">
        <div class="topbar">
            <h2><%= title %></h2>
            <div class="user-info">
                <span><%= lang.common.welcome %>, <strong><%= locals.user ? user.full_name || user.login : 'Admin' %></strong></span>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><%= lang.stockIntake.newIntake %></h3>
                    <a href="/stock-intake" class="btn btn-secondary"><%= lang.common.backToList %></a>
                </div>

                <% if (error) { %>
                    <div class="alert alert-danger"><%= error %></div>
                <% } %>

                <form action="/stock-intake" method="POST" id="intakeForm" data-validate-form>
                    <div class="form-group">
                        <label for="supplier_id" class="form-label required"><%= lang.stockIntake.supplier %></label>
                        <select id="supplier_id" name="supplier_id" class="form-control" data-validate="required" required>
                            <option value=""><%= lang.stockIntake.selectSupplier %></option>
                            <% suppliers.forEach(supplier => { %>
                                <option value="<%= supplier.id %>"><%= supplier.name %></option>
                            <% }) %>
                        </select>
                        <span class="form-error"></span>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><%= lang.stockIntake.products %></label>
                        <div id="productsList">
                            <div class="product-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start;">
                                <div style="flex: 2; position: relative;">
                                    <input type="text" class="form-control product-input" placeholder="<%= lang.stockIntake.selectProduct %>" required autocomplete="off">
                                    <input type="hidden" class="product-id-input">
                                    <input type="hidden" class="product-barcode-input">
                                    <div class="product-suggestions" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; width: 100%;"></div>
                                </div>
                                <input type="number" class="form-control quantity-input" placeholder="<%= lang.stockIntake.quantity %>" min="1" style="flex: 1;" required>
                                <input type="number" step="0.01" class="form-control price-input" placeholder="<%= lang.stockIntake.purchasePrice %>" min="0" style="flex: 1;" required>
                                <input type="number" step="0.01" class="form-control sell-price-input" placeholder="<%= lang.stockIntake.sellPrice || 'Sell Price' %>" min="0" style="flex: 1;">
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addProductRow()"><%= lang.stockIntake.addProduct %></button>
                    </div>

                    <div class="form-group">
                        <label for="notes" class="form-label"><%= lang.common.notes %></label>
                        <textarea id="notes" name="notes" class="form-control" rows="3"></textarea>
                    </div>

                    <input type="hidden" name="items" id="itemsData">

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary"><%= lang.stockIntake.saveIntake %></button>
                        <a href="/stock-intake" class="btn btn-secondary"><%= lang.buttons.cancel %></a>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>

<script>
function addProductRow() {
    const container = document.getElementById('productsList');
    const newRow = container.querySelector('.product-item').cloneNode(true);
    newRow.querySelectorAll('input, select').forEach(input => input.value = '');
    container.appendChild(newRow);
}

document.getElementById('intakeForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const items = [];
    document.querySelectorAll('.product-item').forEach(row => {
        const productInput = row.querySelector('.product-input').value.trim();
        const productId = row.querySelector('.product-id-input').value;
        const productBarcode = row.querySelector('.product-barcode-input').value;
        const quantity = row.querySelector('.quantity-input').value;
        const purchasePrice = row.querySelector('.price-input').value;
        const sellPrice = row.querySelector('.sell-price-input').value;

        if (productInput && quantity && purchasePrice) {
            const item = {
                quantity: parseInt(quantity),
                purchase_price: parseFloat(purchasePrice)
            };

            // If product exists (has ID), use product_id
            if (productId) {
                item.product_id = parseInt(productId);
                // Update sell price if provided
                if (sellPrice) {
                    item.sell_price = parseFloat(sellPrice);
                }
            } else {
                // New product - send name and barcode (if available)
                item.product_name = productInput;
                if (productBarcode) {
                    item.barcode = productBarcode;
                }
                // Sell price is optional but can be set
                if (sellPrice) {
                    item.sell_price = parseFloat(sellPrice);
                }
            }

            items.push(item);
        }
    });

    if (items.length === 0) {
        alert('<%= lang.validation.atLeastOneProduct %>');
        return;
    }

    document.getElementById('itemsData').value = JSON.stringify(items);
    this.submit();
});

// Initialize Select2 for supplier
$(document).ready(function() {
    $('#supplier_id').select2({
        ajax: {
            url: '/suppliers/api/search',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term || ''
                };
            },
            processResults: function (data) {
                return {
                    results: data.map(function(supplier) {
                        return {
                            id: supplier.id,
                            text: supplier.name
                        };
                    })
                };
            },
            cache: true
        },
        placeholder: '<%= lang.stockIntake.selectSupplier %>',
        minimumInputLength: 0,
        allowClear: true
    });

    // Product autocomplete functionality
    let searchTimeout = null;

    // Setup autocomplete for all product inputs
    function setupProductAutocomplete(input) {
        const container = $(input).closest('.product-item');
        const suggestionsDiv = container.find('.product-suggestions');
        const productIdInput = container.find('.product-id-input');
        const productBarcodeInput = container.find('.product-barcode-input');
        const purchasePriceInput = container.find('.price-input');
        const sellPriceInput = container.find('.sell-price-input');

        $(input).on('input', function() {
            const query = $(this).val().trim();

            // Clear timeout if user is still typing
            clearTimeout(searchTimeout);

            if (query.length < 1) {
                suggestionsDiv.hide().empty();
                productIdInput.val('');
                productBarcodeInput.val('');
                return;
            }

            // Search after 300ms delay
            searchTimeout = setTimeout(function() {
                $.ajax({
                    url: '/products/api/search',
                    method: 'GET',
                    data: { q: query },
                    dataType: 'json',
                    success: function(products) {
                        suggestionsDiv.empty();

                        if (products.length > 0) {
                            products.forEach(function(product) {
                                const item = $('<div>')
                                    .css({
                                        padding: '8px 12px',
                                        cursor: 'pointer',
                                        borderBottom: '1px solid #eee'
                                    })
                                    .text(product.name + ' (' + product.barcode + ')')
                                    .hover(
                                        function() { $(this).css('background-color', '#f0f0f0'); },
                                        function() { $(this).css('background-color', 'white'); }
                                    )
                                    .on('click', function() {
                                        // Fill in the product details
                                        $(input).val(product.name);
                                        productIdInput.val(product.id);
                                        productBarcodeInput.val(product.barcode);
                                        purchasePriceInput.val(product.purchase_price || '');
                                        sellPriceInput.val(product.sell_price || '');
                                        suggestionsDiv.hide();
                                    });

                                suggestionsDiv.append(item);
                            });

                            suggestionsDiv.show();
                        } else {
                            // Show "Create new product" option
                            const createItem = $('<div>')
                                .css({
                                    padding: '8px 12px',
                                    cursor: 'pointer',
                                    borderBottom: '1px solid #eee',
                                    fontStyle: 'italic',
                                    color: '#666'
                                })
                                .html('<strong>Create new:</strong> ' + query)
                                .hover(
                                    function() { $(this).css('background-color', '#f0f0f0'); },
                                    function() { $(this).css('background-color', 'white'); }
                                )
                                .on('click', function() {
                                    // Keep the typed name, clear the ID (indicates new product)
                                    productIdInput.val('');
                                    productBarcodeInput.val('');
                                    suggestionsDiv.hide();
                                });

                            suggestionsDiv.append(createItem).show();
                        }
                    },
                    error: function() {
                        suggestionsDiv.hide();
                    }
                });
            }, 300);
        });

        // Hide suggestions when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.product-item').length) {
                $('.product-suggestions').hide();
            }
        });

        // Handle blur event
        $(input).on('blur', function() {
            // Delay to allow click on suggestion
            setTimeout(function() {
                suggestionsDiv.hide();
            }, 200);
        });
    }

    // Initialize autocomplete for existing inputs
    $('.product-input').each(function() {
        setupProductAutocomplete(this);
    });

    // Override addProductRow to setup autocomplete on new rows
    window.originalAddProductRow = window.addProductRow;
    window.addProductRow = function() {
        const container = document.getElementById('productsList');
        const newRow = container.querySelector('.product-item').cloneNode(true);

        // Clear all inputs
        $(newRow).find('input').val('');
        $(newRow).find('.product-suggestions').hide().empty();

        container.appendChild(newRow);

        // Setup autocomplete for new row
        const productInput = $(newRow).find('.product-input')[0];
        setupProductAutocomplete(productInput);
    };
});
</script>

<%- include('../partials/footer') %>
