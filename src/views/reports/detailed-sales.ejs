<%- include('../partials/header') %>

<div class="main-wrapper">
    <%- include('../partials/sidebar') %>

    <main class="main-content">
        <div class="topbar">
            <h2><%= title %></h2>
            <div class="user-info">
                <span>Har bir savdo bo'yicha umumiy foyda va shtraflar</span>
            </div>
        </div>

        <div class="container">
            <!-- Filters -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Filtrlar</h3>
                </div>
                <div class="card-body">
                    <form method="GET" action="/reports/detailed-sales" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label for="seller_id" class="form-label">Sotuvchi</label>
                            <select id="seller_id" name="seller_id" class="form-control">
                                <option value="all" <%= filters.seller_id === 'all' ? 'selected' : '' %>>Barcha sotuvchilar</option>
                                <% sellers.forEach(seller => { %>
                                    <option value="<%= seller.id %>" <%= filters.seller_id == seller.id ? 'selected' : '' %>>
                                        <%= seller.full_name %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="start_date" class="form-label">Boshlanish sanasi</label>
                            <input type="date" id="start_date" name="start_date" class="form-control" value="<%= filters.start_date %>">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="end_date" class="form-label">Tugash sanasi</label>
                            <input type="date" id="end_date" name="end_date" class="form-control" value="<%= filters.end_date %>">
                        </div>
                        <button type="submit" class="btn btn-primary">Filtrlash</button>
                    </form>
                </div>
            </div>

            <!-- Report Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Savdolar bo'yicha hisobot</h3>
                    <button onclick="window.print()" class="btn btn-success">üñ®Ô∏è Chop etish</button>
                </div>

                <div class="table-responsive">
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>T/r</th>
                                <th>Savdo ID</th>
                                <th>Sana</th>
                                <th>Sotuvchi</th>
                                <th>Savdo foydasi</th>
                                <th>Shtraflar</th>
                                <th>Sof foyda</th>
                                <th class="no-print">Amallar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (salesData.length === 0) { %>
                                <tr>
                                    <td colspan="8" class="text-center">Ma'lumot topilmadi</td>
                                </tr>
                            <% } else { %>
                                <%
                                let totalProfit = 0;
                                let totalPenalties = 0;
                                let totalNet = 0;
                                salesData.forEach((sale, index) => {
                                    const saleProfit = parseFloat(sale.sale_profit || 0);
                                    const penalties = parseFloat(sale.total_penalties || 0);
                                    const netProfit = saleProfit - penalties;

                                    totalProfit += saleProfit;
                                    totalPenalties += penalties;
                                    totalNet += netProfit;
                                %>
                                    <tr>
                                        <td><%= index + 1 %></td>
                                        <td><a href="/sales/<%= sale.sale_id %>" style="color: #2563eb; font-weight: bold;">#<%= sale.sale_id %></a></td>
                                        <td><%= new Date(sale.sale_date).toLocaleDateString('ru-RU') %></td>
                                        <td><%= sale.seller_name %></td>
                                        <td style="color: green; font-weight: bold;">$<%= saleProfit.toFixed(2) %></td>
                                        <td style="color: red; font-weight: bold;">-$<%= penalties.toFixed(2) %></td>
                                        <td style="color: <%= netProfit >= 0 ? 'blue' : 'red' %>; font-weight: bold; font-size: 1.1em;">
                                            $<%= netProfit.toFixed(2) %>
                                        </td>
                                        <td class="no-print">
                                            <a href="/sales/<%= sale.sale_id %>" target="_blank" class="btn btn-sm btn-info">Ko'rish</a>
                                            <button onclick="printSale(<%= sale.sale_id %>)" class="btn btn-sm btn-success">Chop</button>
                                        </td>
                                    </tr>
                                <% }) %>
                                <tr style="background: #f0f9ff; font-weight: bold; font-size: 1.1em;">
                                    <td colspan="4" class="text-right"><strong>JAMI:</strong></td>
                                    <td style="color: green;">$<%= totalProfit.toFixed(2) %></td>
                                    <td style="color: red;">-$<%= totalPenalties.toFixed(2) %></td>
                                    <td style="color: blue; font-size: 1.2em;">$<%= totalNet.toFixed(2) %></td>
                                    <td class="no-print"></td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<style>
@media print {
    .sidebar, .topbar, .no-print, .card-header button {
        display: none !important;
    }
    .main-content {
        margin-left: 0 !important;
    }
    table {
        font-size: 12px;
    }
}
</style>

<script>
function printSale(saleId) {
    window.open(`/sales/${saleId}`, '_blank');
}
</script>

<%- include('../partials/footer') %>
